@startuml API Sequence Diagrams
!theme plain
skinparam backgroundColor #FEFEFE

title IFA API Sequence Diagrams

== 1. Seller Registration ==

actor Seller as seller
participant "Frontend" as fe
participant "API\n/auth/register" as api
database "PostgreSQL" as db

seller -> fe : Fill registration form
fe -> api : POST /auth/register\n{email, password, name}
api -> api : Validate input (Zod)
api -> db : Check email exists
alt email exists
    api -> fe : 400 {error: "Email already registered"}
else email available
    api -> api : Hash password (bcrypt)
    api -> api : Generate seller ID (sel_xxx)
    api -> db : INSERT seller
    api -> api : Generate JWT token
    api -> fe : 201 {seller, token}
    fe -> fe : Store token in localStorage
    fe -> seller : Redirect to dashboard
end

== 2. Seller Login ==

seller -> fe : Enter credentials
fe -> api : POST /auth/login\n{email, password}
api -> db : SELECT seller by email
alt seller not found
    api -> fe : 401 {error: "Invalid credentials"}
else seller found
    api -> api : Compare password hash
    alt password invalid
        api -> fe : 401 {error: "Invalid credentials"}
    else password valid
        alt seller suspended
            api -> fe : 403 {error: "Account suspended"}
        else seller active
            api -> api : Generate JWT token
            api -> fe : 200 {seller, token}
        end
    end
end

== 3. Etsy OAuth Flow ==

participant "Etsy API" as etsy
participant "Redis" as redis

seller -> fe : Click "Connect Etsy"
fe -> api : GET /etsy/oauth/authorize
api -> api : Generate PKCE\ncode_verifier (43-128 chars)\ncode_challenge = SHA256(verifier)
api -> api : Generate state (random string)
api -> redis : SET oauth:{state}\n{sellerId, codeVerifier}\nTTL: 5 min
api -> fe : {authorizationUrl}
fe -> etsy : Redirect to Etsy OAuth
etsy -> seller : Show authorization page
seller -> etsy : Approve access
etsy -> api : GET /etsy/oauth/callback\n?code=xxx&state=xxx
api -> redis : GET oauth:{state}
alt state not found
    api -> fe : Redirect with error
else state valid
    api -> etsy : POST /v3/public/oauth/token\n{code, code_verifier, ...}
    etsy -> api : {access_token, refresh_token, expires_in}
    api -> api : Encrypt tokens (AES-256-GCM)
    api -> etsy : GET /v3/application/users/me
    etsy -> api : {user_id}
    api -> etsy : GET /v3/users/{user_id}/shops
    etsy -> api : {shop_id, shop_name, ...}
    api -> db : INSERT etsy_connection
    api -> redis : DEL oauth:{state}
    api -> api : Trigger product sync (async)
    api -> fe : Redirect to dashboard\n?etsy_connected=true
end

== 4. Product Sync ==

participant "Queue Worker" as worker

api -> db : INSERT agent_inbox\n{kind: "system_tick",\npayload: {action: "sync_products"}}
worker -> db : SELECT FROM agent_inbox\nWHERE status='queued'\nFOR UPDATE SKIP LOCKED
worker -> db : UPDATE status='processing'
worker -> db : SELECT etsy_connection
worker -> worker : Decrypt access_token
alt token expired
    worker -> etsy : POST /v3/public/oauth/token\n(refresh_token)
    etsy -> worker : {new_access_token}
    worker -> worker : Encrypt new token
    worker -> db : UPDATE etsy_connection
end
worker -> etsy : GET /v3/shops/{shop_id}/listings\n?state=active&limit=100
etsy -> worker : {listings[]}
loop for each listing
    worker -> db : UPSERT product\nON CONFLICT (seller_id, etsy_listing_id)
end
worker -> db : UPDATE agent_inbox\nstatus='done'

== 5. Agent Provisioning ==

participant "Filesystem" as fs
participant "OpenClaw\nGateway" as oc

seller -> fe : Click "Create Agent"
fe -> api : POST /agents/provision
api -> db : SELECT etsy_connection
alt no connection
    api -> fe : 400 {error: "Connect Etsy first"}
else has connection
    api -> api : Generate agent ID (agt_xxx)
    api -> fs : mkdir ~/.openclaw/workspaces/seller_{id}
    api -> fs : mkdir products/
    api -> fs : mkdir skills/
    api -> db : SELECT products
    api -> fs : Write CLAUDE.md\n(inject shop name, products)
    api -> fs : Write SOUL.md\n(seller instructions template)
    api -> fs : Write .mcp.json\n(Etsy MCP server config)
    api -> fs : Write products/inventory.json
    api -> fs : Write skills/inventory-analysis/SKILL.md
    api -> oc : Register workspace\n(WebSocket message)
    oc -> api : {registered: true}
    api -> db : INSERT agent\n{status: 'active', workspace_path}
    api -> db : INSERT agent_session\n{session_id}
    api -> fe : 201 {agent}
end

== 6. Customer Message Flow ==

actor Customer as cust
participant "WhatsApp\n(Baileys)" as wa
participant "OpenClaw" as oc2
participant "Claude API" as claude

cust -> wa : "Do you have blue mugs?"
wa -> oc2 : Incoming message event
oc2 -> oc2 : Lookup workspace by phone
oc2 -> fs : Read CLAUDE.md, SOUL.md
oc2 -> fs : Read skills/inventory-analysis/SKILL.md
oc2 -> claude : Send context + message
claude -> claude : Process with inventory knowledge
claude -> oc2 : Response text
oc2 -> db : INSERT agent_events\n{type: 'message', ...}
oc2 -> db : INSERT agent_events\n{type: 'response', ...}
oc2 -> wa : Send response
wa -> cust : "Yes! Blue Ocean Ceramic Mug\n$24.99, ships in 2-3 days..."

@enduml
