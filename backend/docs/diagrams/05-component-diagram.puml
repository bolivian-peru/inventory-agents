@startuml Component Diagram
!theme plain
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

title IFA Backend - Component Architecture

package "src/" as src {

    package "config/" as config {
        [env.ts] as env
        [constants.ts] as constants
        note right of env
            Zod schema validation
            for environment variables
        end note
    }

    package "routes/" as routes {
        [index.ts] as routeIndex
        [health.ts] as healthRoute
        [auth.ts] as authRoute
        [etsy-oauth.ts] as etsyRoute
        [products.ts] as productsRoute
        [agents.ts] as agentsRoute
        [skills.ts] as skillsRoute
        [messaging.ts] as messagingRoute
        [dashboard.ts] as dashboardRoute
    }

    package "middleware/" as middleware {
        [auth.ts] as authMw
        [rate-limiter.ts] as rateLimiter
        [error-handler.ts] as errorHandler
    }

    package "services/" as services {
        package "etsy/" as etsyService {
            [oauth.ts] as etsyOAuth
            [client.ts] as etsyClient
            [sync.ts] as etsySync
        }

        package "agents/" as agentService {
            [provisioner.ts] as provisioner
            [gateway.ts] as gateway
        }
    }

    package "skills/" as skills {
        [registry.ts] as registry
        [types.ts] as types

        package "inventory-analysis/" as invSkill {
            [index.ts] as invIndex
            [analyzer.ts] as analyzer
            [manifest.json] as manifest
        }
    }

    package "workers/" as workers {
        [queue-worker.ts] as queueWorker
    }

    package "db/" as db {
        [index.ts] as dbIndex
        [schema.ts] as schema
        [migrate.ts] as migrate
    }

    package "utils/" as utils {
        [crypto.ts] as crypto
        [id.ts] as id
        [logger.ts] as logger
    }

    [app.ts] as app
    [index.ts] as entrypoint
}

' Entry point flow
entrypoint --> app : creates Hono app
app --> routeIndex : mounts routes
app --> errorHandler : global error handling

' Route dependencies
routeIndex --> healthRoute
routeIndex --> authRoute
routeIndex --> etsyRoute
routeIndex --> productsRoute
routeIndex --> agentsRoute
routeIndex --> skillsRoute
routeIndex --> messagingRoute
routeIndex --> dashboardRoute

' Middleware usage
authRoute --> authMw : JWT validation
etsyRoute --> authMw
productsRoute --> authMw
agentsRoute --> authMw
skillsRoute --> authMw
authMw --> rateLimiter : rate limiting

' Service usage
authRoute --> crypto : password hashing
etsyRoute --> etsyOAuth : OAuth flow
etsyRoute --> etsyClient : API calls
productsRoute --> etsySync : product sync
agentsRoute --> provisioner : workspace creation
agentsRoute --> gateway : OpenClaw communication
skillsRoute --> registry : skill management

' Skill dependencies
registry --> invSkill : registers
invIndex --> analyzer : analysis logic

' Worker dependencies
queueWorker --> dbIndex : job queue
queueWorker --> gateway : send messages

' DB usage
authMw --> dbIndex : verify seller
etsyOAuth --> dbIndex : store tokens
etsySync --> dbIndex : store products
provisioner --> dbIndex : store agent

' Utils usage
etsyOAuth --> crypto : encrypt tokens
provisioner --> id : generate IDs
queueWorker --> logger : structured logs

' Config usage
env --> dbIndex : DATABASE_URL
env --> crypto : TOKEN_ENCRYPTION_KEY
env --> etsyOAuth : ETSY_API_KEY

@enduml
